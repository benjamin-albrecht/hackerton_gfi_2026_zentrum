name: Agent Workflow
on:
  workflow_dispatch:
    inputs:
      task:
        description: 'Task to execute'
        required: true
        type: string
      max_iterations:
        description: 'Maximum iterations'
        default: '50'
        required: false
        type: string
      timeout_minutes:
        description: 'Timeout in minutes'
        default: '60'
        required: false
        type: string
      permission_mode:
        description: 'Claude permission mode'
        default: 'bypassPermissions'
        required: false
        type: choice
        options:
          - bypassPermissions
          - default
          - acceptEdits

jobs:
  run-agent:
    name: Run Claude Agent
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJSON(inputs.timeout_minutes) + 10 }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config --global user.name "Claude Agent"
          git config --global user.email "agent@github-actions"

      - name: Install Claude Code
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Run headless agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          MAX_ITERATIONS: ${{ inputs.max_iterations }}
          TIMEOUT_MINUTES: ${{ inputs.timeout_minutes }}
          PERMISSION_MODE: ${{ inputs.permission_mode }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x scripts/run-headless.sh
          ./scripts/run-headless.sh "${{ inputs.task }}"

      - name: Upload session logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-logs-${{ github.run_id }}
          path: .ralph/logs/
          retention-days: 30

      - name: Push changes
        if: success()
        run: |
          git push origin HEAD
